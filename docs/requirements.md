# 要件定義書

## 1. プロジェクト概要

### 1.1 目的
本プロジェクトは、深層学習を用いた画像分類モデルの学習・推論システムを構築することを目的とします。MLOpsのベストプラクティスに基づき、コード、データ、モデルのバージョン管理を行い、再現性の高い機械学習パイプラインを実現します。

### 1.2 技術スタック
- **深層学習フレームワーク**: PyTorch Lightning
- **バージョン管理**:
  - Git: コードのバージョン管理
  - MLflow: モデルのバージョン管理と実験管理
- **データ管理**:
  - **データベース**: 学習データの管理（SQLite/PostgreSQLなど）
  - 画像ファイルはファイルシステムまたはオブジェクトストレージで管理
- **ハイパーパラメータチューニング**: Optuna
- **データドリフト検知**: Alibi-detect（将来実装）
- **Webアプリケーション**: 将来実装（フレームワークは未定）

### 1.3 タスク種別
- マルチクラス分類（3クラス以上）

## 2. 機能要件

### 2.1 学習データ作成機能

#### 2.1.1 テーマ管理
- 複数のテーマを指定可能とする
- テーマ例: MNIST、Fashion-MNIST、異物分類、動物分類など
- 各テーマは独立して管理され、異なるラベルセットを持つことができる
- テーマの作成、編集、削除が可能

#### 2.1.2 ラベル管理
- 各テーマごとにラベルを指定可能とする
- ラベルはクラス分類の学習データ作成に使用される
- ラベルの追加、編集、削除が可能
- 例: 動物分類テーマの場合、「犬」「猫」「鳥」などのラベルを定義

#### 2.1.3 学習データの登録
- 画像データ（または画像パス）を登録可能とする
- 各画像に対して以下を指定:
  - テーマ
  - ラベル（クラス）
  - ラベル付けした人（オプション）
- 画像の一括登録機能を提供

#### 2.1.4 データ分割の管理
- 一度学習させたら、どの画像をtrain/valid/testにしたかをデータベースに保存
- データ分割情報は永続化され、再学習時に再利用される
- **再学習時の分割ルール**:
  - 従来の画像は既存のtrain/valid/test分割を踏襲
  - 新しい画像のみ新規にtrain/valid/testに分割
  - これにより、データリークを防止し、評価の公平性を保証

#### 2.1.5 データベース管理
- 学習データをデータベースで管理
- データベーススキーマは以下のテーブルで構成:
  - **Theme（テーマ）**: テーマ情報を管理
  - **Label（ラベル）**: 各テーマのラベル情報を管理
  - **TrainData（学習データ）**: 画像データとメタデータを管理
  - **Model（モデル）**: 学習済みモデル情報を管理
  - **ModelTrainData（中間テーブル）**: モデルと学習データの関連を管理

### 2.2 モデル学習機能

#### 2.2.1 基本機能
- PyTorch Lightningベースの深層学習モデルを学習可能とする
- LightningModuleを使用したモデル定義
- Trainerによる学習管理（分散学習、混合精度、勾配クリッピングなど）
- マルチクラス分類タスクに対応
- 初期モデルとしてResNet系（ResNet18, ResNet50など）をサポート
- モデルアーキテクチャは後から追加可能な設計とする

#### 2.2.2 学習プロセス
- 訓練データ、検証データ、テストデータに分割して学習
- Lightning Trainerを使用した学習実行
- Callbacksを活用した学習制御（EarlyStopping、ModelCheckpointなど）
- MLflowLoggerを使用して学習中のメトリクス（損失、精度など）をMLflowに記録
- 学習済みモデルをMLflowに登録

### 2.3 データ管理機能

#### 2.3.1 データ読み込み
- データベースから学習データを読み込む
- テーマを指定して、該当テーマの学習データを取得
- データ分割情報（train/valid/test）に基づいてデータを取得
- 画像ファイルはファイルパスから読み込む

#### 2.3.2 データ分割
- 初回学習時: 指定された分割比率でtrain/valid/testに分割
- 再学習時:
  - 既存の画像はデータベースに保存された分割情報を使用
  - 新しい画像のみ新規に分割
  - 分割比率は設定可能（デフォルト: train 70% / valid 15% / test 15%）
- 分割方法は再現可能であること（シード値の固定）

#### 2.3.3 データ分割比率
- デフォルト分割比率: train 70% / valid 15% / test 15%
- 分割方法は再現可能であること（シード値の固定）

#### 2.3.4 データオーグメンテーション
- データオーグメンテーション設定を`auguments.yaml`ファイルで管理
- 学習時にのみ適用されるオーグメンテーション（回転、リサイズ、色調整など）を設定可能
- オーグメンテーション設定の変更履歴はGitで管理
- 一般的なオーグメンテーション手法をサポート（albumentations、torchvision.transformsなど）

#### 2.3.5 画像前処理
- 画像に前処理を適用可能とする
- 前処理の種類:
  - **輝度修正**: ヒストグラム均等化、ガンマ補正など
  - **パッチ化**: 画像を複数のパッチに分割
  - その他、カスタム前処理の追加が可能
- 前処理は学習時と推論時の両方で適用される
- 前処理設定は`params.yaml`または別の設定ファイルで管理
- 前処理済み画像は`artifacts`フォルダに保存可能

#### 2.3.6 Artifacts管理
- `artifacts`フォルダに以下の成果物を保存:
  - 前処理済み画像（オプション）
  - その他の学習時に生成される中間ファイル
- データ分割情報はデータベースで管理されるため、ファイルとして保存する必要はない
- Artifactsは学習実行ごとに管理され、再現性を保証

### 2.4 ハイパーパラメータ管理

#### 2.4.1 パラメータファイル管理
- すべてのハイパーパラメータを`params.yaml`ファイルで一元管理
- パラメータの変更履歴はGitで管理
- **Optunaチューニング用設定**: `optuna_params.yaml`でチューニング対象パラメータと探索範囲を指定

#### 2.4.2 ハイパーパラメータチューニング
- Optunaを使用した自動ハイパーパラメータチューニング機能を実装
- **チューニングフロー**:
  1. `optuna_params.yaml`からチューニング対象パラメータと探索範囲を読み込み
  2. Optunaでトライアルを生成し、各トライアルで`params.yaml`を動的に生成
  3. 生成された`params.yaml`を読み込んでモデルを訓練
  4. 各トライアルの結果をMLflowに記録
  5. 最良のパラメータを選択し、最良の`params.yaml`を生成
  6. 最良モデルをMLflowに登録（最良の`params.yaml`も一緒に保存）
- チューニング結果はMLflowに記録
- **再現性の保証**: 最良の`params.yaml`をMLflowに保存することで、同じパラメータで再現可能

### 2.5 モデル管理機能

#### 2.5.1 モデル登録
- 学習済みモデルをMLflowに登録
- **カスタムPythonModelとして登録**:
  - `mlflow.pyfunc.PythonModel`を継承したカスタムモデルクラスを作成
  - カスタムモデルクラスに学習済みモデルと前処理設定を組み込む
  - `mlflow.log_model()`でカスタムPythonModelを登録
- モデル登録時に以下の情報を記録:
  - モデルアーキテクチャ
  - **ハイパーパラメータ（`params.yaml`ファイルをMLflowに保存）**
  - データオーグメンテーション設定（`auguments.yaml`）
  - 前処理設定（輝度修正、パッチ化など）
  - 学習時のメトリクス
  - 使用した学習データ（データベースから取得）
  - Git commit ID（学習時のコード状態）
- **`params.yaml`の保存**: モデル登録時に使用した`params.yaml`をMLflow artifactsとして保存し、再現性を保証
- 前処理設定はカスタムPythonModel内に組み込まれるため、推論時に自動的に適用される

#### 2.5.2 再現性の保証
- モデル登録時のGit commit IDを使用して、学習時のコードを再現可能とする
- データベースに保存された学習データと分割情報を使用して、同じデータセットで再現可能とする
- モデルと学習データの関連付け（ModelTrainDataテーブル）により、使用したデータを追跡可能

#### 2.5.3 モデルデプロイ
- 学習済みモデルをMLflow Modelsとしてデプロイ
- **カスタムPythonModelの実装**:
  - `mlflow.pyfunc.PythonModel`を継承したカスタムモデルクラスを作成
  - カスタムモデルクラス内で前処理と推論を統合
  - `load_context()`メソッドで学習済みモデルと前処理設定を読み込み
  - `predict()`メソッドで入力画像に前処理を適用してから推論を実行
- `mlflow.log_model()`時にカスタムPythonModelを指定して登録
- MLflow ModelsのREST APIを提供し、推論はMLflow server経由で実行する
- 推論時は前処理が自動的に適用されるため、クライアント側での前処理は不要

### 2.6 データベース設計

#### 2.6.1 データベーススキーマ

**Theme（テーマ）テーブル**
- `id`: 主キー（整数、自動増分）
- `name`: テーマ名（文字列、一意制約）
- `description`: テーマの説明（文字列、オプション）
- `created_at`: 作成日時（タイムスタンプ）
- `updated_at`: 更新日時（タイムスタンプ）

**Label（ラベル）テーブル**
- `id`: 主キー（整数、自動増分）
- `theme_id`: テーマID（外部キー、Theme.idを参照）
- `label_name`: ラベル名（文字列、テーマ内で一意）
- `created_at`: 作成日時（タイムスタンプ）

**TrainData（学習データ）テーブル**
- `id`: 主キー（整数、自動増分）
- `image_path`: 画像ファイルパス（文字列）
- `theme_id`: テーマID（外部キー、Theme.idを参照）
- `label_id`: ラベルID（外部キー、Label.idを参照）
- `split`: データ分割（文字列、'train'/'valid'/'test'）
- `labeled_by`: ラベル付けした人（文字列、オプション）
- `created_at`: 作成日時（タイムスタンプ）
- `updated_at`: 更新日時（タイムスタンプ）

**Model（モデル）テーブル**
- `id`: 主キー（整数、自動増分）
- `theme_id`: テーマID（外部キー、Theme.idを参照）
- `mlflow_run_id`: MLflowのrun_id（文字列、一意制約）
- `created_at`: 作成日時（タイムスタンプ）
- `updated_at`: 更新日時（タイムスタンプ）

**ModelTrainData（モデル-学習データ関連）テーブル**
- `model_id`: モデルID（外部キー、Model.idを参照）
- `train_data_id`: 学習データID（外部キー、TrainData.idを参照）
- 複合主キー: (model_id, train_data_id)

#### 2.6.2 リレーション
- Theme 1対多 Label
- Theme 1対多 TrainData
- Theme 1対多 Model
- Label 1対多 TrainData
- Model 多対多 TrainData（ModelTrainData中間テーブル経由）

#### 2.6.3 データベース機能要件
- テーマ、ラベル、学習データのCRUD操作
- 学習データの分割情報の保存と取得
- モデルと学習データの関連付け
- 再学習時の既存分割情報の取得と新規データの分割

### 2.7 Webアプリケーション機能（将来実装）

#### 2.7.1 目的
- 非エンジニアでも簡単にモデル学習を実行できるようにする
- コマンドライン操作を不要とし、Webブラウザからすべての操作を可能にする

#### 2.7.2 学習データ作成機能
- Webアプリ上でテーマの作成・管理が可能
- Webアプリ上でラベルの作成・管理が可能
- Webアプリ上で画像のアップロードとラベル付けが可能
- 画像の一括アップロード機能
- ラベル付けの進捗管理

#### 2.7.3 ハイパーパラメータ設定機能
- Webアプリ上でハイパーパラメータを設定可能とする
- 設定可能なパラメータ:
  - モデルアーキテクチャの選択（ResNet18, ResNet50など）
  - 学習率、バッチサイズ、エポック数など
  - データ分割比率（train/valid/test）
  - その他`params.yaml`で定義されるすべてのパラメータ
- 設定したパラメータは`params.yaml`として保存される
- パラメータのバリデーション機能を提供

#### 2.7.3.1 データオーグメンテーション設定機能
- Webアプリ上でデータオーグメンテーション設定を可能とする
- 設定可能なオーグメンテーション:
  - 回転、リサイズ、色調整など
  - 一般的なオーグメンテーション手法をUIから選択可能
- 設定内容は`auguments.yaml`として保存される

#### 2.7.3.2 前処理設定機能
- Webアプリ上で画像前処理設定を可能とする
- 設定可能な前処理:
  - 輝度修正（ヒストグラム均等化、ガンマ補正など）
  - パッチ化設定
  - その他のカスタム前処理
- 前処理設定は`params.yaml`または別の設定ファイルとして保存される

#### 2.7.4 学習実行機能
- 学習開始ボタンをクリックすると、バックエンドで学習が開始される
- 学習の進捗状況をリアルタイムで表示（進捗バー、現在のエポック、損失値など）
- 学習中のメトリクスをグラフで可視化
- 学習完了後、結果を表示（最終的な精度、損失値など）
- 学習済みモデルは自動的にMLflowに登録される

#### 2.7.5 学習履歴・結果確認機能
- 過去の学習履歴を一覧表示
- 各学習の詳細情報を確認可能:
  - 使用したデータセット
  - ハイパーパラメータ
  - 学習結果（メトリクス）
  - MLflowへの登録情報
- 学習結果の比較機能（複数の学習結果を並べて比較）

#### 2.7.6 ユーザビリティ要件
- 直感的で使いやすいUI/UX
- エラーメッセージは分かりやすく表示
- 操作ガイドやヘルプ機能を提供
- 非エンジニアでも理解できる用語を使用

#### 2.7.7 WebUI遷移・ページ構成（Label-Studio風UI）

##### 2.7.7.1 認証・ログイン

**ログイン画面（`/login/`）**
- **URL**: `/login/`
- **機能**:
  - ユーザー名・パスワードによるログイン
  - ログイン状態の保持（セッション管理）
- **遷移先**: テーマ一覧画面（`/`）

##### 2.7.7.2 実装済みページ（Label-Studio風ラベリングUI）

**1. テーマ一覧画面（`/`）**
- **URL**: `/`
- **アクセス条件**: ログイン必須
- **機能**:
  - テーマ一覧の表示（カード形式またはリスト形式）
  - 各テーマの基本情報表示（テーマ名、説明、画像数、ラベル数など）
  - 「新規作成」ボタン
  - テーマの検索・フィルタリング機能（将来実装）
- **遷移先**:
  - テーマ内画面（`/theme/<theme_id>/`）
  - テーマ新規作成画面（`/theme/create/`）

**2. テーマ新規作成画面（`/theme/create/`）**
- **URL**: `/theme/create/`
- **機能**:
  - テーマ名の入力
  - テーマ説明の入力（オプション）
  - ラベル情報の編集（ラベルの追加・削除・編集）
  - ラベル名の入力
  - 設定の保存
- **遷移先**:
  - テーマ内画面（`/theme/<theme_id>/`）- 作成完了後、自動遷移
  - テーマ一覧画面（`/`）- キャンセル時

**3. テーマ内画面（`/theme/<theme_id>/`）**
- **URL**: `/theme/<theme_id>/`
- **機能**:
  - **画像一覧表示**:
    - アップロード済み画像のグリッド表示（ページネーション対応）
    - 画像サムネイル表示
    - 各画像のラベル状態表示（ラベル済み/未ラベル）
    - データ分割状態表示（train/valid/test）
  - **画像操作**:
    - 画像の追加（ドラッグ&ドロップ、ファイル選択）
    - 画像の削除
    - 画像のラベル更新（クリックまたはキーボードショートカット）
    - 画像の詳細表示（モーダル）
  - **ラベルパレット**:
    - ラベル一覧表示
    - ラベル選択（クリックまたはキーボードショートカット 1-9）
    - 選択中のラベルのハイライト表示
  - **フィルタリング**:
    - すべて/未ラベル/ラベル済みでフィルタリング
    - ラベル別フィルタリング（将来実装）
    - データ分割別フィルタリング（train/valid/test）
  - **統計情報表示**:
    - リアルタイム統計表示（総画像数、ラベル済み数、未ラベル数）
    - データ分割統計（train/valid/test数）
    - ラベル別統計（各ラベルの画像数）
  - **データ分割機能**:
    - データ分割実行ボタン
    - 分割比率の設定（train/valid/test）
    - ランダムシードの設定
  - **テーマ設定**:
    - テーマ情報の編集（テーマ名、説明）
    - ラベル情報の編集（ラベルの追加・削除・編集）
- **遷移先**:
  - テーマ一覧画面（`/`）
  - テーマ設定画面（`/theme/<theme_id>/settings/`）- 将来実装

**4. Django Admin管理画面（`/admin/`）**
- **URL**: `/admin/`
- **機能**:
  - テーマ、ラベル、学習データ、モデルの管理
  - スーパーユーザー専用
  - 詳細な管理機能（一括操作、エクスポートなど）
- **遷移先**: 各管理画面（Django Admin標準）

##### 2.7.7.3 将来実装予定ページ

**5. テーマ設定画面（`/theme/<theme_id>/settings/`）**
- **URL**: `/theme/<theme_id>/settings/`
- **機能**:
  - テーマ情報の編集（テーマ名、説明）
  - ラベル情報の編集（ラベルの追加・削除・編集）
  - テーマの削除
- **遷移先**:
  - テーマ内画面（`/theme/<theme_id>/`）
  - テーマ一覧画面（`/`）

**6. ハイパーパラメータ設定画面（`/theme/<theme_id>/training/config/`）**
- **URL**: `/theme/<theme_id>/training/config/`
- **機能**:
  - モデルアーキテクチャの選択（ResNet18, ResNet50など）
  - ハイパーパラメータの設定（学習率、バッチサイズ、エポック数など）
  - データ分割比率の設定（train/valid/test）
  - データオーグメンテーション設定（`auguments.yaml`編集）
  - 前処理設定（輝度修正、パッチ化など）
  - パラメータのバリデーション
  - 設定の保存（`params.yaml`、`auguments.yaml`）
- **遷移先**:
  - 学習実行画面（`/theme/<theme_id>/training/run/`）
  - テーマ内画面（`/theme/<theme_id>/`）

**7. 学習実行画面（`/theme/<theme_id>/training/run/`）**
- **URL**: `/theme/<theme_id>/training/run/`
- **機能**:
  - 学習開始ボタン
  - リアルタイム進捗表示（進捗バー、現在のエポック、損失値など）
  - 学習中のメトリクスグラフ（損失、精度など）
  - 学習ログの表示
  - 学習の一時停止・再開・キャンセル機能
- **遷移先**:
  - 学習結果画面（`/theme/<theme_id>/training/result/<run_id>/`）
  - ハイパーパラメータ設定画面（`/theme/<theme_id>/training/config/`）

**8. 学習結果画面（`/theme/<theme_id>/training/result/<run_id>/`）**
- **URL**: `/theme/<theme_id>/training/result/<run_id>/`
- **機能**:
  - 学習結果の詳細表示（最終精度、損失値など）
  - メトリクスグラフの表示（学習曲線）
  - 使用したデータセット情報
  - ハイパーパラメータ情報
  - MLflowへの登録情報
  - モデルのダウンロード
- **遷移先**:
  - 学習履歴一覧（`/theme/<theme_id>/training/history/`）
  - 学習実行画面（`/theme/<theme_id>/training/run/`）

**9. 学習履歴一覧（`/theme/<theme_id>/training/history/`）**
- **URL**: `/theme/<theme_id>/training/history/`
- **機能**:
  - 過去の学習履歴の一覧表示
  - 学習結果の比較機能（複数の学習結果を並べて比較）
  - フィルタリング・ソート機能
  - 各学習結果へのリンク
- **遷移先**:
  - 学習結果画面（`/theme/<theme_id>/training/result/<run_id>/`）
  - テーマ内画面（`/theme/<theme_id>/`）

**10. 推論画面（将来実装）**
- **URL**: `/theme/<theme_id>/inference/`
- **機能**:
  - モデルの選択
  - 画像のアップロード（単一またはバッチ）
  - 推論結果の表示
  - 推論結果のダウンロード
- **遷移先**:
  - テーマ内画面（`/theme/<theme_id>/`）

##### 2.7.7.4 UI遷移図

```
┌──────────────┐
│  ログイン画面  │
│   /login/   │
└──────┬───────┘
       │
       ▼
┌─────────────────┐
│   テーマ一覧画面  │
│       (/)       │
└──────┬──────────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
┌──────────────┐ ┌──────────────────┐
│ 新規作成画面  │ │   テーマ内画面    │
│/theme/create/│ │/theme/<id>/     │
└──────┬───────┘ └────────┬─────────┘
       │                   │
       │                   │ (将来実装)
       │                   ▼
       │          ┌──────────────────┐
       │          │  テーマ設定画面   │
       │          │/theme/<id>/settings/│
       │          └──────────────────┘
       │                   │
       │                   │ (将来実装)
       │                   ▼
       │          ┌──────────────────┐
       │          │ハイパーパラメータ設定│
       │          │/training/config/ │
       │          └────────┬─────────┘
       │                   │
       │                   ▼
       │          ┌──────────────────┐
       │          │   学習実行画面   │
       │          │  /training/run/ │
       │          └────────┬─────────┘
       │                   │
       │                   ▼
       │          ┌──────────────────┐
       │          │   学習結果画面   │
       │          │/training/result/<id>/│
       │          └────────┬─────────┘
       │                   │
       │                   ▼
       │          ┌──────────────────┐
       │          │  学習履歴一覧    │
       │          │/training/history/│
       │          └──────────────────┘
       │
       └───────────┐
                   │
                   ▼
         ┌──────────────────┐
         │  Django Admin     │
         │    /admin/        │
         └──────────────────┘
```

##### 2.7.7.5 主要なワークフロー

**ワークフロー1: 新規テーマ作成からラベリング**
1. ログイン画面（`/login/`）でログイン
2. テーマ一覧画面（`/`）で「新規作成」ボタンをクリック
3. テーマ新規作成画面（`/theme/create/`）で以下を設定:
   - テーマ名を入力
   - ラベル情報を編集（ラベルの追加）
   - 設定を保存
4. テーマ内画面（`/theme/<theme_id>/`）に自動遷移
5. テーマ内画面で画像をアップロード
6. テーマ内画面でラベリング（画像をクリックしてラベルを選択）
7. データ分割を実行
8. テーマ一覧画面に戻る

**ワークフロー2: 既存テーマでのラベリング**
1. ログイン画面（`/login/`）でログイン
2. テーマ一覧画面（`/`）でテーマをクリック
3. テーマ内画面（`/theme/<theme_id>/`）で以下を実行:
   - 画像の追加・削除
   - ラベルの更新（画像をクリックしてラベルを選択）
   - データ分割の実行
4. テーマ一覧画面に戻る

**ワークフロー3: モデル学習実行（将来実装）**
1. テーマ一覧画面（`/`）でテーマを選択
2. テーマ内画面（`/theme/<theme_id>/`）から学習設定へ
3. ハイパーパラメータ設定画面（`/theme/<theme_id>/training/config/`）で設定
4. 学習実行画面（`/theme/<theme_id>/training/run/`）で学習開始
5. 学習結果画面（`/theme/<theme_id>/training/result/<run_id>/`）で結果確認
6. 学習履歴一覧（`/theme/<theme_id>/training/history/`）で過去の結果と比較

##### 2.7.7.6 ナビゲーション要件

- **グローバルナビゲーション**: すべてのページに共通のナビゲーションバーを配置
  - ロゴ/ホームリンク（テーマ一覧画面へ）
  - 現在のテーマ名表示（テーマ内画面の場合）
  - ユーザー情報・ログアウトボタン
  - ヘルプ/ドキュメントリンク（将来実装）
- **パンくずリスト**: 現在のページ位置を表示（例: テーマ一覧 > テーマ名）
- **サイドバー**: テーマ内画面で表示（将来実装）
  - 画像一覧
  - ラベリング
  - テーマ設定
  - 学習設定
  - 学習実行
  - 学習履歴

##### 2.7.7.7 REST APIエンドポイント（既存実装）

- **ラベル更新API**: `POST /api/theme/<theme_id>/label/update/`
- **データ分割API**: `POST /api/theme/<theme_id>/split/`
- **統計取得API**: `GET /api/theme/<theme_id>/statistics/`
- **画像アップロードAPI**: `POST /api/theme/<theme_id>/images/upload/`
- **画像削除API**: `DELETE /api/theme/<theme_id>/images/<image_id>/`

##### 2.7.7.8 REST APIエンドポイント（将来実装）

- **テーマ作成API**: `POST /api/theme/create/`
- **テーマ更新API**: `PUT /api/theme/<theme_id>/`
- **ラベル管理API**: `POST /api/theme/<theme_id>/labels/`, `PUT /api/theme/<theme_id>/labels/<label_id>/`, `DELETE /api/theme/<theme_id>/labels/<label_id>/`
- **学習開始API**: `POST /api/theme/<theme_id>/training/start/`
- **学習進捗取得API**: `GET /api/theme/<theme_id>/training/progress/<run_id>/`
- **学習履歴取得API**: `GET /api/theme/<theme_id>/training/history/`
- **学習結果取得API**: `GET /api/theme/<theme_id>/training/result/<run_id>/`
- **ハイパーパラメータ保存API**: `POST /api/theme/<theme_id>/training/config/save/`

### 2.8 将来機能

#### 2.8.1 データドリフト検知
- Alibi-detectを使用したデータドリフト検知機能を将来的に実装
- 本機能は要件定義のみとし、実装は後続フェーズで行う

## 3. 非機能要件

### 3.1 再現性
- 同じGit commit IDとデータベースの学習データを使用することで、完全に同じ学習結果を再現可能であること
- データベースに保存された分割情報を使用することで、同じデータ分割で再現可能であること
- ランダムシードの固定により、学習結果の再現性を保証

### 3.2 バージョン管理
- コード: Gitで管理
- 学習データ: データベースで管理
- モデル: MLflowで管理
- 各バージョン間の対応関係を追跡可能

### 3.3 拡張性
- 新しいモデルアーキテクチャを追加する際、既存コードへの影響を最小限に抑える設計
- モデル定義をモジュール化し、設定ファイルから選択可能とする

### 3.4 保守性
- コードの可読性と保守性を重視
- 適切なコメントとドキュメントを提供

## 4. プロジェクト構造案

```
classification_with_mlops/
├── README.md
├── requirements.txt
├── params.yaml              # ハイパーパラメータ設定（Optunaで生成される場合あり）
├── optuna_params.yaml       # Optunaチューニング設定（探索範囲など）
├── auguments.yaml           # データオーグメンテーション設定
├── database.db             # データベースファイル（SQLiteの場合）
├── .gitignore
├── docs/
│   └── requirements.md      # 本要件定義書
├── src/
│   ├── __init__.py
│   ├── models/              # モデル定義
│   │   ├── __init__.py
│   │   ├── resnet.py
│   │   ├── model_factory.py # モデルファクトリ
│   │   └── mlflow_model.py  # MLflow PythonModel継承クラス
│   ├── data/               # データ処理
│   │   ├── __init__.py
│   │   ├── dataset.py      # データセット読み込み（DBから）
│   │   ├── split.py        # データ分割ロジック
│   │   ├── augmentation.py # データオーグメンテーション
│   │   └── preprocessing.py # 画像前処理（輝度修正、パッチ化など）
│   ├── database/           # データベース関連
│   │   ├── __init__.py
│   │   ├── models.py       # データベースモデル定義
│   │   ├── crud.py         # CRUD操作
│   │   └── connection.py   # データベース接続
│   ├── training/           # 学習関連
│   │   ├── __init__.py
│   │   ├── train.py        # 学習スクリプト
│   │   ├── lightning_module.py  # LightningModule定義
│   │   └── callbacks.py    # Lightning Callbacks
│   ├── inference/          # 推論関連（将来実装）
│   │   └── __init__.py
│   ├── tuning/             # ハイパーパラメータチューニング
│   │   ├── __init__.py
│   │   └── optuna_tuner.py
│   ├── web/                # Webアプリケーション（将来実装）
│   │   ├── __init__.py
│   │   ├── app.py          # Webアプリケーション本体
│   │   ├── api/            # APIエンドポイント
│   │   │   ├── __init__.py
│   │   │   ├── training.py # 学習API
│   │   │   └── dataset.py  # データセット管理API
│   │   ├── static/         # 静的ファイル（CSS, JS）
│   │   └── templates/      # HTMLテンプレート
│   └── utils/              # ユーティリティ
│       ├── __init__.py
│       └── mlflow_utils.py # MLflow連携
├── images/                 # 画像ファイル保存ディレクトリ
│   └── [theme_id]/        # テーマごとのディレクトリ
├── artifacts/              # 成果物
│   └── preprocessed/       # 前処理済み画像（オプション）
├── experiments/            # MLflow実験結果
└── scripts/                # 実行スクリプト
    ├── train.py
    ├── tune.py
    └── register_model.py
```

## 5. データフロー

### 5.1 学習フロー（コマンドライン）
1. `params.yaml`からハイパーパラメータを読み込み
2. `auguments.yaml`からデータオーグメンテーション設定を読み込み
3. テーマを指定してデータベースから学習データを取得
4. データ分割情報を確認:
   - 既存の画像はデータベースに保存されたsplit情報を使用
   - 新しい画像のみ新規に分割（train/valid/test）
5. 新規分割した画像のsplit情報をデータベースに保存
6. 画像前処理を適用（輝度修正、パッチ化など）
7. LightningModuleを初期化
8. データローダーにオーグメンテーションを適用（学習時のみ）
9. Lightning Trainerを設定（MLflowLogger、Callbacksなど）
10. Trainer.fit()で学習を実行
11. 学習中のメトリクスはMLflowLoggerにより自動的にMLflowに記録
12. カスタムPythonModelクラスを初期化（学習済みモデルと前処理設定を含む）
13. `mlflow.log_model()`でカスタムPythonModelを登録
14. 使用した`params.yaml`をMLflow artifactsとして保存
15. モデル情報をデータベースに登録（Modelテーブル、ModelTrainDataテーブル）
16. モデル登録時にGit commit IDを記録

### 5.1.1 学習フロー（Webアプリケーション経由）
1. ユーザーがWebアプリ上でテーマを選択または作成
2. ユーザーがWebアプリ上でラベルを設定
3. ユーザーがWebアプリ上で画像をアップロードし、ラベル付け
4. ユーザーがWebアプリ上でハイパーパラメータを設定
5. 設定内容を`params.yaml`として保存
6. ユーザーが学習開始ボタンをクリック
7. バックエンドで学習を開始（5.1のフローを実行）
8. 学習進捗をリアルタイムでWebアプリに送信・表示
9. 学習完了後、結果をWebアプリに表示
10. モデルをMLflowに登録（Git commit IDを記録）

### 5.2 推論フロー
1. MLflow serverからモデルを取得（カスタムPythonModel）
2. 推論リクエストを受信（生の画像データ）
3. MLflow Models API経由で推論を実行
4. カスタムPythonModelの`predict()`メソッド内で以下を実行:
   - 入力画像に前処理を適用（輝度修正、パッチ化など）
   - 前処理済み画像で推論を実行
5. 結果を返却
- 前処理はカスタムPythonModel内で自動的に適用されるため、クライアント側での前処理は不要

### 5.3 ハイパーパラメータチューニングフロー
1. `optuna_params.yaml`からチューニング対象パラメータと探索範囲を読み込み
2. OptunaでStudyを作成
3. 各トライアルで以下を実行:
   a. Optunaがパラメータ値を提案
   b. 提案されたパラメータ値で`params.yaml`を動的に生成
   c. 生成された`params.yaml`を読み込んでモデルを訓練
   d. 検証メトリクスを取得
   e. Optunaにメトリクスを報告
   f. トライアルの結果をMLflowに記録（`params.yaml`も含む）
4. すべてのトライアル完了後、最良のパラメータを選択
5. 最良のパラメータで`params.yaml`を生成
6. 最良モデルをMLflowに登録（最良の`params.yaml`も一緒に保存）
7. 再現性の保証: 保存された`params.yaml`を使用して同じモデルを再現可能

## 6. 制約事項

- 推論はMLflow server経由でのみ実行（ローカル推論コードは不要）
- データ分割は一貫性を保証する必要がある
- モデル登録時には必ずGit commit IDを記録する

## 7. 今後の拡張予定

- **Webアプリケーションの実装**
  - 非エンジニア向けのWebインターフェース
  - データセットアップロード機能
  - ハイパーパラメータ設定UI
  - 学習実行・進捗表示機能
  - 学習履歴・結果確認機能
- Alibi-detectによるデータドリフト検知機能の実装
- 追加モデルアーキテクチャのサポート（EfficientNet、Vision Transformerなど）
- 推論APIの拡張（バッチ推論、ストリーミング推論など）

