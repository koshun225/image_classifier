{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ theme.name }} - ç”»åƒåˆ†é¡ãƒ‡ãƒ¼ã‚¿ç®¡ç†{% endblock %}

{% block content %}
<div class="theme-detail-container">
    <div class="page-header">
        <h1>{{ theme.name }}</h1>
        <a href="{% url 'theme_list' %}" class="btn btn-secondary">â† ãƒ†ãƒ¼ãƒä¸€è¦§ã«æˆ»ã‚‹</a>
    </div>
    
    <div class="theme-detail-content">
        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="statistics-panel">
            <div class="stat-item">
                <span class="stat-label">ç·ç”»åƒæ•°:</span>
                <span class="stat-value" id="total-count">{{ stats.train|add:stats.valid|add:stats.test|add:stats.unsplit }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Train:</span>
                <span class="stat-value" id="train-count">{{ stats.train }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Valid:</span>
                <span class="stat-value" id="valid-count">{{ stats.valid }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Test:</span>
                <span class="stat-value" id="test-count">{{ stats.test }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">æœªåˆ†å‰²:</span>
                <span class="stat-value" id="unsplit-count">{{ stats.unsplit }}</span>
            </div>
        </div>
        
        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="filter-section">
            <div class="filter-group">
                <label class="filter-label">è¡¨ç¤º:</label>
                <div class="filter-buttons">
                    <button class="filter-btn {% if filter_type == 'all' %}active{% endif %}" data-filter-type="all">ã™ã¹ã¦</button>
                    <button class="filter-btn {% if filter_type == 'unlabeled' %}active{% endif %}" data-filter-type="unlabeled">æœªãƒ©ãƒ™ãƒ«</button>
                    <button class="filter-btn {% if filter_type == 'labeled' %}active{% endif %}" data-filter-type="labeled">ãƒ©ãƒ™ãƒ«æ¸ˆã¿</button>
                </div>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">ãƒ©ãƒ™ãƒ«:</label>
                <select id="filter-label" class="filter-select">
                    <option value="">ã™ã¹ã¦ã®ãƒ©ãƒ™ãƒ«</option>
                    {% for label in labels %}
                    <option value="{{ label.id }}" {% if filter_label|stringformat:"s" == label.id|stringformat:"s" %}selected{% endif %}>
                        {{ label.label_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">åˆ†å‰²:</label>
                <div class="filter-buttons">
                    <button class="filter-split-btn {% if not filter_split %}active{% endif %}" data-filter-split="">ã™ã¹ã¦</button>
                    <button class="filter-split-btn {% if filter_split == 'train' %}active{% endif %}" data-filter-split="train">Train</button>
                    <button class="filter-split-btn {% if filter_split == 'valid' %}active{% endif %}" data-filter-split="valid">Valid</button>
                    <button class="filter-split-btn {% if filter_split == 'test' %}active{% endif %}" data-filter-split="test">Test</button>
                    <button class="filter-split-btn {% if filter_split == 'unsplit' %}active{% endif %}" data-filter-split="unsplit">æœªåˆ†å‰²</button>
                </div>
            </div>
            
            <button id="clear-filters-btn" class="btn btn-clear" title="ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¯ãƒªã‚¢">
                ğŸ”„ ã‚¯ãƒªã‚¢
            </button>
        </div>
        
        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="action-panel">
            <div class="action-left">
                <button id="upload-btn" class="btn btn-primary">ğŸ“¤ ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                <button id="split-btn" class="btn btn-secondary">ğŸ”€ ãƒ‡ãƒ¼ã‚¿åˆ†å‰²å®Ÿè¡Œ</button>
                <a href="{% url 'model_development' theme.id %}" class="btn btn-secondary">ğŸ¤– ãƒ¢ãƒ‡ãƒ«é–‹ç™º</a>
                <a href="{% url 'model_list' theme.id %}" class="btn btn-secondary">ğŸ“Š ãƒ¢ãƒ‡ãƒ«ä¸€è¦§</a>
            </div>
            <div class="action-right">
                <button id="view-grid-btn" class="btn btn-view active" title="ã‚«ãƒ¼ãƒ‰è¡¨ç¤º">
                    <span>ğŸ”²</span>
                </button>
                <button id="view-table-btn" class="btn btn-view" title="è¡¨å½¢å¼">
                    <span>ğŸ“‹</span>
                </button>
            </div>
        </div>
        
        <!-- ç”»åƒã‚°ãƒªãƒƒãƒ‰ï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰ -->
        <div class="image-grid" id="image-grid">
            {% for traindata in page_obj %}
            <div class="image-card" data-image-id="{{ traindata.id }}">
                <div class="image-wrapper">
                    <img src="{{ traindata.image.url }}" alt="ç”»åƒ" class="image-thumbnail">
                    <div class="image-overlay">
                        <button class="btn-image-delete" data-image-id="{{ traindata.id }}">å‰Šé™¤</button>
                    </div>
                </div>
                <div class="image-info">
                    <div class="image-label {% if traindata.label %}labeled{% else %}unlabeled{% endif %}">
                        {% if traindata.label %}
                        <span class="label-badge">{{ traindata.label.label_name }}</span>
                        {% else %}
                        <span class="label-badge unlabeled">æœªãƒ©ãƒ™ãƒ«</span>
                        {% endif %}
                    </div>
                    {% if traindata.split %}
                    <div class="image-split split-{{ traindata.split }}">{{ traindata.get_split_display }}</div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <p>ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- ç”»åƒãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆè¡¨å½¢å¼ï¼‰ -->
        <div class="image-table-container" id="image-table" style="display: none;">
            <table class="image-table">
                <thead>
                    <tr>
                        <th>ã‚µãƒ ãƒã‚¤ãƒ«</th>
                        <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                        <th>ãƒ©ãƒ™ãƒ«</th>
                        <th>ãƒ‡ãƒ¼ã‚¿åˆ†å‰²</th>
                        <th>ãƒ©ãƒ™ãƒ«ä»˜ã‘æ‹…å½“è€…</th>
                        <th>ä½œæˆæ—¥æ™‚</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for traindata in page_obj %}
                    <tr class="table-row" data-image-id="{{ traindata.id }}">
                        <td class="thumbnail-cell">
                            <img src="{{ traindata.image.url }}" alt="ç”»åƒ" class="table-thumbnail">
                        </td>
                        <td class="filename-cell">{{ traindata.image.name|basename }}</td>
                        <td class="label-cell">
                            {% if traindata.label %}
                            <span class="label-badge-table labeled">{{ traindata.label.label_name }}</span>
                            {% else %}
                            <span class="label-badge-table unlabeled">æœªãƒ©ãƒ™ãƒ«</span>
                            {% endif %}
                        </td>
                        <td class="split-cell">
                            {% if traindata.split %}
                            <span class="split-badge split-{{ traindata.split }}">{{ traindata.get_split_display }}</span>
                            {% else %}
                            <span class="split-badge">-</span>
                            {% endif %}
                        </td>
                        <td class="labeled-by-cell">{{ traindata.labeled_by|default:"-" }}</td>
                        <td class="created-at-cell">{{ traindata.created_at|date:"Y-m-d H:i" }}</td>
                        <td class="actions-cell">
                            <button class="btn-table-label" data-image-id="{{ traindata.id }}">ãƒ©ãƒ™ãƒ«ç·¨é›†</button>
                            <button class="btn-table-delete" data-image-id="{{ traindata.id }}">å‰Šé™¤</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="empty-state">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&filter={{ filter_type }}{% if filter_label %}&label={{ filter_label }}{% endif %}{% if filter_split %}&split={{ filter_split }}{% endif %}" class="pagination-link">å‰ã¸</a>
            {% endif %}
            <span class="pagination-current">ãƒšãƒ¼ã‚¸ {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&filter={{ filter_type }}{% if filter_label %}&label={{ filter_label }}{% endif %}{% if filter_split %}&split={{ filter_split }}{% endif %}" class="pagination-link">æ¬¡ã¸</a>
            {% endif %}
        </div>
        {% endif %}
        
        <!-- ãƒ©ãƒ™ãƒ«ã”ã¨ã®è©³ç´°çµ±è¨ˆ -->
        {% if label_stats %}
        <div class="label-statistics">
            <h3>ğŸ“Š ãƒ©ãƒ™ãƒ«ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿åˆ†å¸ƒ</h3>
            <div class="table-wrapper">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>ãƒ©ãƒ™ãƒ«</th>
                            <th>Train</th>
                            <th>Valid</th>
                            <th>Test</th>
                            <th>æœªåˆ†å‰²</th>
                            <th>åˆè¨ˆ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in label_stats %}
                        <tr>
                            <td class="label-cell">
                                <strong>{{ stat.label.label_name }}</strong>
                            </td>
                            <td class="count-cell">
                                <span class="count-badge train-badge">{{ stat.train }}</span>
                            </td>
                            <td class="count-cell">
                                <span class="count-badge valid-badge">{{ stat.valid }}</span>
                            </td>
                            <td class="count-cell">
                                <span class="count-badge test-badge">{{ stat.test }}</span>
                            </td>
                            <td class="count-cell">
                                <span class="count-badge unsplit-badge">{{ stat.unsplit }}</span>
                            </td>
                            <td class="total-cell">
                                <strong>{{ stat.total }}</strong>
                            </td>
                        </tr>
                        {% endfor %}
                        <tr class="total-row">
                            <td><strong>åˆè¨ˆ</strong></td>
                            <td class="count-cell">
                                <span class="count-badge train-badge"><strong>{{ stats.train }}</strong></span>
                            </td>
                            <td class="count-cell">
                                <span class="count-badge valid-badge"><strong>{{ stats.valid }}</strong></span>
                            </td>
                            <td class="count-cell">
                                <span class="count-badge test-badge"><strong>{{ stats.test }}</strong></span>
                            </td>
                            <td class="count-cell">
                                <span class="count-badge unsplit-badge"><strong>{{ stats.unsplit }}</strong></span>
                            </td>
                            <td class="total-cell">
                                <strong>{{ stats.train|add:stats.valid|add:stats.test|add:stats.unsplit }}</strong>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="upload-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2>ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
        <form id="upload-form" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label for="upload-label">ãƒ©ãƒ™ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                <select id="upload-label" name="label_id" class="form-control">
                    <option value="">æœªãƒ©ãƒ™ãƒ«</option>
                    {% for label in labels %}
                    <option value="{{ label.id }}">{{ label.label_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="upload-images">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</label>
                <input type="file" id="upload-images" name="images" multiple accept="image/*" class="form-control">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                <button type="button" class="btn btn-secondary modal-close-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </form>
    </div>
</div>

<!-- ãƒ‡ãƒ¼ã‚¿åˆ†å‰²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="split-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2>ãƒ‡ãƒ¼ã‚¿åˆ†å‰²å®Ÿè¡Œ</h2>
        <form id="split-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="train-ratio">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿æ¯”ç‡</label>
                <input type="number" id="train-ratio" name="train_ratio" value="0.7" min="0" max="1" step="0.05" class="form-control">
            </div>
            <div class="form-group">
                <label for="valid-ratio">æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿æ¯”ç‡</label>
                <input type="number" id="valid-ratio" name="valid_ratio" value="0.15" min="0" max="1" step="0.05" class="form-control">
            </div>
            <div class="form-group">
                <label for="test-ratio">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ¯”ç‡</label>
                <input type="number" id="test-ratio" name="test_ratio" value="0.15" min="0" max="1" step="0.05" class="form-control">
            </div>
            <div class="form-group">
                <label for="random-seed">ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ¼ãƒ‰</label>
                <input type="number" id="random-seed" name="random_seed" value="42" class="form-control">
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="unsplit-only" name="unsplit_only" checked>
                    <span>æœªåˆ†å‰²ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’åˆ†å‰²ï¼ˆãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å†åˆ†å‰²ï¼‰</span>
                </label>
                <p class="help-text">
                    âš ï¸ ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ã€æ—¢å­˜ã®åˆ†å‰²æƒ…å ±ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã¨ã®æ•´åˆæ€§ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
                </p>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">å®Ÿè¡Œ</button>
                <button type="button" class="btn btn-secondary modal-close-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </form>
    </div>
</div>

<!-- ç”»åƒè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="image-modal" class="modal">
    <div class="modal-content modal-large">
        <span class="modal-close">&times;</span>
        <div id="image-modal-content"></div>
    </div>
</div>

<script>
const themeId = {{ theme.id }};
const csrfToken = '{{ csrf_token }}';
const labels = [
    {% for label in labels %}
    { id: {{ label.id }}, name: '{{ label.label_name }}' }{% if not forloop.last %},{% endif %}
    {% endfor %}
];
</script>
<script src="{% static 'js/theme_detail.js' %}?v=20251117103200"></script>
{% endblock %}

